<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=windows-1252">
    <link rel="icon" type="image/png" href="/ScholarlyStanzasFavIcon.gif">
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-W2KDLNPB3M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'G-W2KDLNPB3M');
    </script>
    <title>Scholarly Stanzas - A Songbook</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        svg {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        svg text {
            fill: silver;
        }

        svg g g {
            display: none;
        }

        body {
            font-family: sans-serif;
            background: black;
            color: silver;
        }

        #frame-container {
            display: none;
        }

        iframe {
            border: 0;
            overflow: hidden;
            text-align: center;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .sort-btn-left {
            float: left;
            margin: 20px;
        }

        .sort-btn-right {
            float: right;
            margin: 20px;
        }

        #vis {
            margin-bottom: 40px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .container {
            clear: both;
        }

        .menu-button {
            margin-top: 20px;
            font-size: 12px;
            color: rgb(245, 245, 245);
            text-decoration: none;
            cursor: pointer;
        }

        #back-btn {
            text-align: center;
            margin: 20px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <center><img src="ScholarlyStanzasMainTitle.png" alt="Scholarly Stanzas Main Title"
            title="Scholarly Stanzas Main Title" style="width: 650px;">

        <p>
            <a href="https://hypergraphia.com/ScholarlyStanzas/Scholarly%20Stanzas%20-%20Prologue.html"
                title="Scholarly Stanzas Prologue" target="_blank" class="menu-button">PROLOGUE</a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="https://hypergraphia.com/ScholarlyStanzas/Scholarly%20Stanzas%20-%20About%20the%20Project.html"
                title="About Scholarly Stanzas" target="_blank" class="menu-button">ABOUT THE PROJECT</a>
        </p>

    </center>
    <div>
        <div id="areas" class="sort-btn-left" title="Areas of Study">
            <img src="./ScholarlyStanzasAreasNav.png" width="100px" height="100px" />
        </div>
        <div id="alpha" class="sort-btn-right" title="Alphabetical">
            <img src="./ScholarlyStanzasAlphabeticalNav.png" width="100px" height="100px" />
        </div>
        <div class="container">
            <div id="vis"></div>
            <div id="frame-container">
                <div id="back-btn" class="menu-button">
                    BACK
                </div>
                <iframe id="frame" src="" allow="fullscreen 'self' https://hypergraphia.com"></iframe>
            </div>
        </div>
        <script>
            const container = d3.select("#vis");
            const bbox = container.node().getBoundingClientRect();
            const MAX_WIDTH = 1280;
            const width = Math.min(Math.max(bbox.width, bbox.height) - 80, MAX_WIDTH),
                height = width;
            const svg = container.append("svg").attr("width", width).attr("height", height);
            // maximum line length for text on each slice before splitting into two lines
            const MAX_LINE_LENGTH = 25;
            // maximum ratio of largest slice to smallest slice
            // decreasing it makes the slices more evenly sized
            const SLICE_RATIO = 5;
            // number of possible images in the center
            const N_CENTER_IMAGES = 188
            const AREAS_OF_STUDY = {};
            const ALPHA = {};
            const SITEMAP_AREAS = {
                name: "sitemap",
                children: []
            };
            const SITEMAP_ALPHA = {
                name: "sitemap",
                children: []
            };
            const SORT = {
                AREAS: "areas",
                ALPHA: "alpha"
            };

            function splitText(text) {
                if (text.length <= MAX_LINE_LENGTH) {
                    return [text];
                }
                let words = text.split(" ");
                if (words.length == 1) {
                    return words;
                }
                let lines = [""];
                words.forEach(w => {
                    if (lines[0].length == 0) {
                        lines[0] = w;
                    } else if (lines[0].length + w.length < MAX_LINE_LENGTH) {
                        lines[0] = lines[0] + " " + w;
                    } else if (lines.length == 2) {
                        lines[1] = lines[1] + " " + w;
                    } else {
                        lines.push(w);
                    }
                });
                return lines;
            }

            function drawSunburst(svg, type) {
                const data = type == SORT.AREAS ? SITEMAP_AREAS : SITEMAP_ALPHA;
                const categories = type == SORT.AREAS ? AREAS_OF_STUDY : ALPHA;

                svg.selectAll("*").remove();

                const defs = svg.append("defs");
                for (var i = 1; i <= N_CENTER_IMAGES; i++) {
                    const pattern = defs.append("pattern")
                        .attr("id", `center${i}`)
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("width", 1)
                        .attr("height", 1)
                        .attr("viewbox", "256 256 768 768")
                        .attr("preserveAspectRatio", "xMidYMid slice")
                        .attr("patternContentUnits", "objectBoundingBox");
                    pattern.append("image")
                        .attr("x", -0.5)
                        .attr("y", -0.5)
                        .attr("width", 2)
                        .attr("height", 2)
                        .attr("xlink:href", `./images/LP-background${i}.png`);
                }

                const g = svg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);
                const radius = (Math.min(width, height) / 4);
                const maxSize = d3.max(Object.values(categories), x => x.length);

                const factors = {};
                for (const [key, value] of Object.entries(categories)) {
                    if (value.length < maxSize / SLICE_RATIO) {
                        factors[key] = maxSize / SLICE_RATIO / value.length;
                    } else {
                        factors[key] = 1;
                    }
                }

                const root = d3.hierarchy(data).sum(d => {
                        if ('Page Title' in d) {
                            if (type == SORT.ALPHA) {
                                return Math.floor(factors[d["Page Title"].charAt(0).toUpperCase()]);
                            } else {
                                return Math.floor(factors[d["Areas of Study"]]);
                            }
                        }
                        return 0;
                    })
                    .sort((a, b) => a.data.name.localeCompare(b.data.name));
                root.each(d => d.current = d);
                const partition = d3.partition()
                    .size([2 * Math.PI, root.height + 1]);
                const nodes = partition(root).descendants().slice(1);
                const color = d3.scaleOrdinal(d3.quantize(d3.interpolateRainbow, data.children.length + 1));
                const arc = d3.arc()
                    .startAngle(d => d.x0)
                    .endAngle(d => d.x1)
                    .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
                    .padRadius(radius * 1.5)
                    .innerRadius(d => d.y0 * radius)
                    .outerRadius(d => Math.max(d.y0 * radius, d.y1 * radius - 1));

                const path = g.selectAll("path")
                    .data(nodes)
                    .join(enter => enter.append("path")
                        .attr("fill", d => {
                            while (d.depth > 1) d = d.parent;
                            return color(d.data.name);
                        })
                        .attr("fill-opacity", d => arcVisible(d.current) ? (d.children ? 0.6 : 0.4) : 0)
                        .attr("pointer-events", d => arcVisible(d.current) ? "auto" : "none")
                        .attr("d", d => arc(d.current))
                        .style("cursor", "pointer")
                        .on("click", clicked));

                path.append("title")
                    .text(d => d.data.name);

                const label = g
                    .selectAll(".labelGroup")
                    .data(nodes, d => d.data.name)
                    .join(enter => {
                        let text = enter.append("g")
                            .attr("class", "labelGroup")
                            .attr("transform", d => labelTransform(d.current))
                            .style("display", d => +labelVisible(d.current) ? "inline" : "none")
                            .append("text")
                            .attr("dy", d => splitText(d.data.name).length > 1 ? "-0.35em" : "0.35em")
                            .attr("pointer-events", "none")
                            .attr("text-anchor", "middle")
                            .style("user-select", "none");

                        text.append("tspan")
                            .attr("dy", d => splitText(d.data.name).length > 1 ? "-0.35em" : "0.35em")
                            .attr("x", "0")
                            .text(d => splitText(d.data.name)[0]).attr("pointer-events", "none")
                            .attr("text-anchor", "middle")
                            .style("user-select", "none");

                        text.append("tspan")
                            .attr("dy", "1em")
                            .attr("x", "0")
                            .text(d => {
                                let split = splitText(d.data.name);
                                return split.length > 1 ? split[1] : "";
                            }).attr("pointer-events", "none")
                            .attr("text-anchor", "middle")
                            .style("user-select", "none");
                    });

                const centerImgNo = Math.ceil(Math.random() * N_CENTER_IMAGES);
                const parent = g.append("circle")
                    .datum(root)
                    .attr("r", radius)
                    .attr("fill", `url(#center${centerImgNo})`)
                    .attr("pointer-events", "all")
                    .on("click", clicked);

                function clicked(event, p) {
                    if (p.data.URL != null) {
                        d3.select("#frame").attr("src", p.data.URL)
                        d3.select("#frame-container").style("display", "block");
                        d3.select("#vis").style("display", "none");
                        return;
                    }
                    parent.datum(p.parent || root);

                    root.each(d => d.target = {
                        x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                        x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                        y0: Math.max(0, d.y0 - p.depth),
                        y1: Math.max(0, d.y1 - p.depth)
                    });

                    const t = g.transition().duration(750);

                    path.transition(t)
                        .tween("data", d => {
                            const i = d3.interpolate(d.current, d.target);
                            return t => d.current = i(t);
                        })
                        .attr("fill-opacity", d => arcVisible(d.target) ? (d.children ? 0.6 : 0.4) : 0)
                        .attr("pointer-events", d => arcVisible(d.target) ? "auto" : "none")
                        .attrTween("d", d => () => arc(d.current));

                    g.selectAll(".labelGroup")
                        .data(nodes, d => d.data.name)
                        .transition(t)
                        .style("display", d => +labelVisible(d.target) ? "inline" : "none")
                        .attrTween("transform", d => () => labelTransform(d.current));
                }

                function arcVisible(d) {
                    return d.y1 <= 2 && d.y0 >= 1 && d.x1 >= d.x0;
                }

                function labelVisible(d) {
                    return d.y1 <= 2 && d.y0 >= 1 && (d.y1 - d.y0) * (d.x1 - d.x0) > 0.01;
                }

                function labelTransform(d) {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const y = (d.y0 + d.y1) / 2 * radius;
                    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                }
            }

            function draw(type) {
                const data = type == SORT.AREAS ? SITEMAP_AREAS : SITEMAP_ALPHA;
                drawSunburst(svg, type);
            }

            d3.csv("./ScholarlyStanzas.csv").then(data => {
                data = data.filter(d => d["Page Title"] !== '');
                data.forEach(d => {
                    d.name = d["Page Title"];
                    d.children = [];

                    const aos = d['Areas of Study'];
                    if (!(aos in AREAS_OF_STUDY)) {
                        AREAS_OF_STUDY[aos] = [];
                    }
                    AREAS_OF_STUDY[aos].push(d);

                    const first = d["Page Title"].charAt(0).toUpperCase();
                    if (!(first in ALPHA)) {
                        ALPHA[first] = [];
                    }
                    ALPHA[first].push(d);
                });

                for (const [key, value] of Object.entries(AREAS_OF_STUDY)) {
                    const areaNode = {
                        name: key,
                        children: value
                    };
                    SITEMAP_AREAS.children.push(areaNode);
                }
                for (const [key, value] of Object.entries(ALPHA)) {
                    const alphaNode = {
                        name: key,
                        children: value
                    };
                    SITEMAP_ALPHA.children.push(alphaNode);
                }
                draw(SORT.AREAS);
            });
            d3.select("#alpha").on('click', _ => {
                draw(SORT.ALPHA);
            });
            d3.select("#areas").on('click', _ => {
                draw(SORT.AREAS);
            });
            d3.select("#frame").attr("width", width).attr("height", width * 0.8);
            d3.select("#back-btn").on("click", _ => {
                d3.select("#frame-container").style("display", "none");
                d3.select("#vis").style("display", "block");
            });
        </script>
</body>

</html>